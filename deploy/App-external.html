<!DOCTYPE html>
<html>
<head>
    <title>point-burndown</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var ITERATION_ID=0,DATA=[],DATE_ITR=null,START_DATE=null,END_DATE=null,UNCOMMITTED_SCHEDULE_STATES=["Idea"],COMPLETED_SCHEDULE_STATES=["Released"];Ext.define("CustomApp",{extend:"Rally.app.App",launch:function(){var types=Rally.data.ModelFactory.types;Rally.data.ModelFactory.getModel({type:"iteration",context:this.getContext().getDataContext(),success:this.onIterationModelLoaded,scope:this})},onIterationModelLoaded:function(model){var iteration_id=47998626614;model.load(iteration_id,{fetch:["ObjectID","StartDate","EndDate"],callback:this.onIterationLoaded,scope:this})},onIterationLoaded:function(record,operation){operation.wasSuccessful()&&(console.log("Iteration Model Loaded"),ITERATION_ID=record.get("ObjectID"),START_DATE=new Date(record.get("StartDate")),END_DATE=new Date(record.get("EndDate")),DATE_ITR=START_DATE,console.log("Iteration ID: "+ITERATION_ID),console.log("Start Date: "+new Date(DATE_ITR).toISOString()),this.loadWorkItemsForDate(DATE_ITR))},loadWorkItemsForDate:function(date){var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["PlanEstimate","ScheduleState"],autoLoad:!0,listeners:{load:this.onWorkItemsLoaded,scope:this},context:this.getContext().getDataContext(),limit:1/0,hydrate:["ScheduleState"],find:{Iteration:ITERATION_ID,__At:date.toISOString()}})},onWorkItemsLoaded:function(store,records){console.log("Work Items Loaded: "+records.length);for(var i=0;DATA.length>i;i++)if(DATA[i].date==DATE_ITR)return!1;var date_data={};date_data.date=new Date(DATE_ITR.valueOf());for(var total_scope=0,completed_scope=0,j=0;records.length>j;j++){var record_data=records[j].data;console.log(record_data.ScheduleState+" - "+record_data.PlanEstimate),_.contains(UNCOMMITTED_SCHEDULE_STATES,record_data.ScheduleState)||(total_scope+=record_data.PlanEstimate,_.contains(COMPLETED_SCHEDULE_STATES,record_data.ScheduleState)&&(completed_scope+=record_data.PlanEstimate))}date_data.total_scope=total_scope,date_data.completed_scope=completed_scope,console.log("Total = "+total_scope+" & Completed = "+completed_scope),DATA.push(date_data),END_DATE>=DATE_ITR?(DATE_ITR.setDate(DATE_ITR.getDate()+1),console.log("New Date - "+DATE_ITR),this.loadWorkItemsForDate(DATE_ITR)):this.createHighChartData()},createHighChartData:function(){this.add({xtype:"rallychart",loadMask:!1,chartData:this._getChartData(),chartConfig:this._getChartConfig()})},_getChartData:function(){for(var dates=[],totals=[],remainings=[],i=0;DATA.length>i;i++)dates.push(DATA[i].date.toDateString()),totals.push(DATA[i].total_scope),remainings.push(DATA[i].total_scope-DATA[i].completed_scope);return{categories:dates,series:[{name:"Total Scope",data:totals,type:"line"},{name:"Remaining Scope",data:remainings,type:"column"}]}},_getChartConfig:function(){return{chart:{defaultSeriesType:"area",zoomType:"xy"},title:{text:"Iteration Burndown"},xAxis:{tickmarkPlacement:"on",tickInterval:1,title:{text:"Date",margin:10}},yAxis:[{title:{text:"Points"}}],tooltip:{formatter:function(){return""+this.x+"<br />"+this.series.name+": "+this.y}},plotOptions:{series:{marker:{enabled:!1,states:{hover:{enabled:!0}}},groupPadding:.01},column:{stacking:null,shadow:!1}}}}});

            Rally.launchApp('CustomApp', {
                name:"point-burndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
